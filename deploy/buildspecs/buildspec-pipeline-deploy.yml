version: 0.2

phases:
  install:
    commands:
  pre_build:
    commands:
      # Build the Settings.xml file
      - REPO_USERNAME=$(aws ssm get-parameters --names "/build/repository/username" | awk '/"Value"/ {print $2}' | sed -e 's/^"//' -e 's/",$//')
      - REPO_PASSWORD=$(aws ssm get-parameters --with-decryption --names "/build/repository/password" | awk '/"Value"/ {print $2}' | sed -e 's/^"//' -e 's/",$//')

      - echo '<?xml version="1.0" encoding="utf-8"?>' > /root/.m2/settings.xml
      - echo '<settings>' >> /root/.m2/settings.xml
      - echo '  <servers>' >> /root/.m2/settings.xml
      - echo '    <server>' >> /root/.m2/settings.xml
      - echo '      <id>central</id>' >> /root/.m2/settings.xml
      - echo '      <username>'${REPO_USERNAME}'</username>' >> /root/.m2/settings.xml
      - echo '      <password>'${REPO_PASSWORD}'</password>' >> /root/.m2/settings.xml
      - echo '    </server>' >> /root/.m2/settings.xml
      - echo '    <server>' >> /root/.m2/settings.xml
      - echo '      <id>snapshots</id>' >> /root/.m2/settings.xml
      - echo '      <username>'${REPO_USERNAME}'</username>' >> /root/.m2/settings.xml
      - echo '      <password>'${REPO_PASSWORD}'</password>' >> /root/.m2/settings.xml
      - echo '    </server>' >> /root/.m2/settings.xml
      - echo '  </servers>' >> /root/.m2/settings.xml
      - echo '</settings>' >> /root/.m2/settings.xml

      # Get the environment variables for use in the deployment templates
      - export REPO_CENTRAL_NAME=$(aws ssm get-parameters --names "/build/repository/central/name" | awk '/"Value"/ {print $2}' | sed -e 's/^"//' -e 's/",$//')
      - export REPO_SNAPSHOT_NAME=$(aws ssm get-parameters --names "/build/repository/snapshot/name" | awk '/"Value"/ {print $2}' | sed -e 's/^"//' -e 's/",$//')
      - export REPO_CENTRAL_URL=$(aws ssm get-parameters --names "/build/repository/central/url" | awk '/"Value"/ {print $2}' | sed -e 's/^"//' -e 's/",$//')
      - export REPO_SNAPSHOT_URL=$(aws ssm get-parameters --names "/build/repository/snapshot/url" | awk '/"Value"/ {print $2}' | sed -e 's/^"//' -e 's/",$//')
      - export REPO_CENTRAL_PLUGIN_NAME=$(aws ssm get-parameters --names "/build/repository/central/plugin/name" | awk '/"Value"/ {print $2}' | sed -e 's/^"//' -e 's/",$//')
      - export REPO_SNAPSHOT_PLUGIN_NAME=$(aws ssm get-parameters --names "/build/repository/snapshot/plugin/name" | awk '/"Value"/ {print $2}' | sed -e 's/^"//' -e 's/",$//')
      - export REPO_CENTRAL_PLUGIN_URL=$(aws ssm get-parameters --names "/build/repository/central/plugin/url" | awk '/"Value"/ {print $2}' | sed -e 's/^"//' -e 's/",$//')
      - export REPO_SNAPSHOT_PLUGIN_URL=$(aws ssm get-parameters --names "/build/repository/snapshot/plugin/url" | awk '/"Value"/ {print $2}' | sed -e 's/^"//' -e 's/",$//')
      - export CLOUDFORMATION_BUCKET=$(aws ssm get-parameters --names "/build/cloudformation/bucket/name" | awk '/"Value"/ {print $2}' | sed -e 's/^"//' -e 's/",$//')
      - export POWERUSER_ROLE_ARN=$(aws ssm get-parameters --names "/build/poweruser/arn" | awk '/"Value"/ {print $2}' | sed -e 's/^"//' -e 's/",$//')
  build:
    commands:
      # Deploy the stacks
      - mvn cloudformation:deploy -P Master

      # Login to AWS Elastic Container Repository Service
      - $(aws ecr get-login --no-include-email --region us-east-1)

      # Build and Push the Docker container to the AWS Container Registry
      - GEOPDP_LATEST=$(aws ssm get-parameters --names "/build/docker/geopdp_latest" | awk '/"Value"/ {print $2}' | sed -e 's/^"//' -e 's/",$//')
      - GEOPDP_LATEST=0$GEOPDP_LATEST
      - GEOPDP_LATEST=$(expr $GEOPDP_LATEST + 1)
      - aws ssm put-parameter --name "/build/docker/geopdp_latest" --value $GEOPDP_LATEST --type "String" --overwrite > /dev/null 2>&1
      - docker build --tag geopdp:v$GEOPDP_LATEST .
      - docker push $AWS_ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/geopdp_latest:v$GEOPDP_LATEST

      # Record new version
      - echo $AWS_ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/geopdp_latest:v$GEOPDP_LATEST > out/deployed.txt
  post_build:
    commands:
artifacts:
  files:
    - '**/*'
  base-directory: target
  discard-paths: no
